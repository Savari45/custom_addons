<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="custom_invoice_report_id" model="ir.actions.report">
        <field name="name">Custom Invoice</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">custom_header.custom_invoice_template</field>
        <field name="report_file">custom_header.custom_invoice_template</field>
        <field name="print_report_name">'Invoice - %s' % (object.name)</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
    </record>

    <template id="custom_invoice_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-set="company" t-value="o.company_id"/>
                <t t-call="web.external_layout">
                    <!-- Invoice Details Section -->
                    <div class="page">
                        <div class="oe_structure"/>
                        <div class="row"/>
                        <span></span>
                        <br/>
                        <br/>
                        <br/>
                        <div class="oe_structure"></div>
                        <div id="informations" class="row mb-4" style="font-size: 13px;">
                            <div class="col" t-if="o.name" name="invoice_no">
                                <strong>Invoice No:</strong>
                                <div t-field="o.name"/>
                            </div>
                            <div class="col" t-if="o.invoice_date" name="invoice_date">
                                <t t-if="o.move_type == 'out_invoice'">
                                    <strong>Invoice Date</strong>
                                </t>
                                <t t-elif="o.move_type == 'out_refund'">
                                    <strong>Credit Note Date</strong>
                                </t>
                                <t t-elif="o.move_type == 'out_receipt'">
                                    <strong>Receipt Date</strong>
                                </t>
                                <t t-else="">
                                    <strong>Date</strong>
                                </t>
                                <div t-esc="o.invoice_date.strftime('%d-%m-%Y')">2023-09-12</div>
                            </div>
                            <div class="col"
                                 t-if="o.invoice_date_due and o.move_type == 'out_invoice' and o.state == 'posted'"
                                 name="due_date">
                                <strong>Due Date</strong>
                                <br/>
                                <t t-esc="o.invoice_date_due.strftime('%d-%m-%Y') if o.invoice_date_due else ''"/>
                            </div>
                            <div class="col" t-if="o.delivery_date" name="delivery_date">
                                <strong>Delivery Date</strong>
                                <br/>
                                <t t-esc="o.delivery_date.strftime('%d-%m-%Y') if o.delivery_date else ''"/>
                            </div>
                            <div class="col" t-if="o.partner_id.ref" name="customer_code">
                                <strong>Customer Code</strong>
                                <div t-field="o.partner_id.ref"/>
                            </div>
                            <div class="col" t-if="o.ref" name="reference">
                                <strong>Reference</strong>
                                <div t-field="o.ref">INV/2023/00001</div>
                            </div>
                            <div class="col" t-if="o.invoice_incoterm_id" name="incoterm_id">
                                <strong>Incoterm</strong>
                                <div t-if="o.incoterm_location">
                                    <span t-field="o.invoice_incoterm_id.code"/>
                                    <br/>
                                    <span t-field="o.incoterm_location"/>
                                </div>
                                <div t-else="" t-field="o.invoice_incoterm_id.code" class="m-0"/>
                            </div>
                        </div>

                        <t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>
                        <div class="oe_structure"></div>
                        <table class="o_has_total_table table o_main_table table-borderless" name="invoice_line_table">
                            <thead style="font-size: 14px;">
                                <tr>
                                    <th name="th_no" class="text-start">
                                        <span>S.No</span>
                                    </th>
                                    <th name="th_product" class="text-center">
                                        <span>Products Name</span>
                                    </th>
                                    <th name="th_hsn" class="text-center">
                                        <span>HSN</span>
                                    </th>
                                    <!--                                    <th style="border: 1px solid black; padding: 5px; text-align: center;">Pack</th>-->
                                    <th name="th_hsn" class="text-center">
                                        <span>Batch</span>
                                    </th>
                                    <th name="th_ex" class="text-center">
                                        <span>Exp.Dt</span>
                                    </th>
                                    <th name="th_mrp" class="text-center">
                                        <span>MRP</span>
                                    </th>
                                    <th name="th_discount" t-if="display_discount"
                                        t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span>Disc.%</span>
                                    </th>
                                    <th name="th_ty" class="text-center">
                                        <span>Qty</span>
                                    </th>
                                    <th name="th_rate" class="text-center">
                                        <span>Rate</span>
                                    </th>
                                    <th name="th_tax" class="text-center">
                                        <span>Taxes</span>
                                    </th>
                                    <th name="th_amount" class="text-center">
                                        <span>Amount</span>
                                    </th>
                                </tr>
                            </thead>

                            <tbody class="invoice_tbody" style="font-size: 11px;">
                                <t t-set="current_subtotal" t-value="0"/>
                                <t t-set="current_total" t-value="0"/>
                                <t t-set="lines"
                                   t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>
                                <!--                                <t t-set="section_index" t-value="0"/>-->
                                <tr t-foreach="o.invoice_line_ids" t-as="line" t-foreach-index="p_index"
                                    style="border-none">
                                    <!--                                    <t t-set="section_index" t-value="index + 1"/>-->
                                    <!-- Serial Number -->
                                    <td style="padding: 5px; text-align: center;">
                                        <t t-esc="line_index + 1"/>
                                    </td>

                                    <!-- Product Name -->
                                    <td style="padding: 5px;" t-esc="line.name"/>

                                    <!-- Fix for HSN Code AttributeError -->
                                    <td style="padding: 5px; text-align: center;">
                                        <t t-if="o.company_id.account_fiscal_country_id.code == 'IN'">
                                            <t t-if="line.l10n_in_hsn_code" t-esc="line.l10n_in_hsn_code"/>
                                        </t>
                                    </td>

                                    <!--            <td style="border: 1px solid black; padding: 5px; text-align: center;" t-esc="line.pack"/>-->
                                    <td style="padding: 5px; text-align: center;">
                                        <t t-esc="', '.join(line.x_lot_ids.mapped('name'))"/>
                                    </td>
                                    <td style="padding: 5px; text-align: center;"
                                        t-esc="line.x_expiry_date"/>
                                    <td style=" padding: 5px; text-align: center;"
                                        t-esc="line.x_mrp_invoice"/>
                                    <td name="td_discount" t-if="display_discount"
                                        t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span class="text-nowrap" t-field="line.discount">0</span>
                                    </td>
                                    <td style=" padding: 5px; text-align: center;"
                                        t-esc="line.quantity"/>
                                    <td style=" padding: 5px; text-align: center;"
                                        t-esc="line.price_unit"/>
                                    <td style=" padding: 5px; text-align: center;">
                                        <t t-esc="', '.join(line.tax_ids.mapped('name'))"/>
                                    </td>
                                    <td style="padding: 5px; text-align: right;"
                                        t-esc="line.price_subtotal"/>
                                </tr>
                            </tbody>
                        </table>
                        <table width="100%" style="border-collapse: collapse; margin: auto; font-size: 12px;">
                            <tr>
                                <!-- Bank Details (Left Aligned) -->
                                <td style="width: 30%; text-align: left; font-size: 12px; vertical-align: top; padding: 5px;">
                                    <strong>Name:</strong>
                                    HDFC Bank
                                    <br/>
                                    <strong>Branch:</strong>
                                    Santhome, Chennai
                                    <br/>
                                    <strong>A/C No:</strong>
                                    50200089670161
                                    <br/>
                                    <strong>IFSC Code:</strong>
                                    HDFC0000386
                                    <br/>
                                    <strong>UPI ID:</strong>
                                    173204618534@hdfcbank
                                    <br/>
                                </td>
                                <!-- HSN Summary (Centered) -->
                                <td style="width: 34%; text-align: center; padding: 5px; font-size: 12px; vertical-align: top;  padding: 5px;">
                                    <div style="display: flex; justify-content: center;">
                                        <t t-if="o.company_id.account_fiscal_country_id.code == 'IN'">
                                            <t t-set="hsn_summary"
                                               t-value="o._l10n_in_get_hsn_summary_table()"/>
                                            <t t-if="hsn_summary">
                                                <div name="l10n_in_hsn_summary" class="mt-3"
                                                     style="page-break-inside: avoid;">
                                                    <table class="table table-sm table-borderless col-6">
                                                        <thead style="font-size: 11px;">
                                                            <tr>
                                                                <th class="text-end">GST %</th>
                                                                <th class="text-end">Taxable Amt</th>
                                                                <th class="text-end"
                                                                    t-if="hsn_summary['has_gst']">SGST
                                                                </th>
                                                                <th class="text-end"
                                                                    t-if="hsn_summary['has_gst']">CGST
                                                                </th>
                                                                <th class="text-end"
                                                                    t-if="hsn_summary['has_igst']">IGST
                                                                </th>
                                                                <th class="text-end"
                                                                    t-if="hsn_summary['has_cess']">CESS
                                                                </th>
                                                                <th class="text-end">Total Tax</th>
                                                            </tr>
                                                        </thead>
                                                        <tr t-foreach="hsn_summary['items']"
                                                            t-as="item">
                                                            <td class="text-end" t-esc="item['rate']"/>
                                                            <td class="text-end">
                                                                <span t-esc="item['amount_untaxed']"
                                                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                            </td>
                                                            <td class="text-end"
                                                                t-if="hsn_summary['has_gst']">
                                                                <span t-esc="item['tax_amount_sgst']"
                                                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                            </td>
                                                            <td class="text-end"
                                                                t-if="hsn_summary['has_gst']">
                                                                <span t-esc="item['tax_amount_cgst']"
                                                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                            </td>
                                                            <td class="text-end"
                                                                t-if="hsn_summary['has_igst']">
                                                                <span t-esc="item['tax_amount_igst']"
                                                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                            </td>
                                                            <td class="text-end"
                                                                t-if="hsn_summary['has_cess']">
                                                                <span t-esc="item['tax_amount_cess']"
                                                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                            </td>
                                                            <td class="text-end">
                                                                <t t-set="total_tax"
                                                                   t-value="(item.get('tax_amount_sgst', 0) or 0) + (item.get('tax_amount_cgst', 0) or 0) + (item.get('tax_amount_igst', 0) or 0) + (item.get('tax_amount_cess', 0) or 0)"/>
                                                                <span t-esc="total_tax"
                                                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </t>
                                        </t>
                                    </div>
                                </td>


                                <td style="width: 33%; vertical-align: top; padding: 5px;">
                                    <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">

                                                <t t-if="o.tax_totals">
                                                    <t t-call="account.document_tax_totals_template">
                                                        <t t-set="currency" t-value="o.currency_id"/>
                                                        <t t-set="tax_totals" t-value="o.tax_totals"/>
                                                    </t>
                                                </t>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                        <t t-set="total_discount"
                           t-value="sum(line.price_unit * line.quantity * (line.discount / 100.0) for line in o.invoice_line_ids)"/>

                        <p t-if="o.company_id.display_invoice_amount_total_words">
                            <small style="font-size: 11px;">Total amount in words:</small>
                            <small class="text-muted lh-sm">
                                <span t-field="o.amount_total_words">Thirty one dollar and Five cents</span>
                            </small>
                            <small style="font-size: 11px;"> Total Discount: </small><small class="text-muted lh-sm"> <span t-esc="total_discount"
                                      t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></small>
                        </p>

                        <table style="width: 100%; margin-top: 10px; text-align: center; border-top: 1px solid black;">
                            <tr>
                                <td style="width: 30%; text-align: center;">
                                    <strong>Customer Signature</strong>
                                </td>
                                <td style="width: 30%; text-align: center; font-size: 12px;">
                                    <p>Subject to our Chennai Jurisdiction.
                                        <br/>
                                        Goods once sold will not be taken back.
                                    </p>
                                </td>
                                <td style="width: 30%; text-align: center;">
                                    <strong>For Greenish (India) Trades Pvt Ltd</strong>
                                    <br/>
                                    <br/>
                                    <strong>Authorised Signatory</strong>
                                </td>
                            </tr>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
